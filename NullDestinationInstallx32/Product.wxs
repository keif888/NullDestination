<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductVersion = "0.0.2.0"?>
  <?define UpgradeCode = "06AA2844-998D-4474-8FDF-F3345A7AE175"?>
  <?define Manufacturer = "Keith Martin"?>
  <?define PackageCode = "*"?>
  <Product Id="*"
           Name="Null Destination x32"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">
    <Package Id="$(var.PackageCode)"
         Description="Null Destination SSIS Destination Component"
         Comments="Installs version $(var.ProductVersion) of the dll's required for this component to work."
         InstallerVersion="300"
         Manufacturer="$(var.Manufacturer)"
         Compressed="yes"
         InstallScope="perMachine"
         Platform="x86"/>
    <Property Id="ARPHELPLINK" Value="https://github.com/keif888/NullDestination/" />

    <Media Id="1" Cabinet="NullDestination.cab" EmbedCab="yes" />

    <MajorUpgrade
      Schedule="afterInstallInitialize"
      DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."/>

    <UIRef Id="WixUI_Mondo"/>
    <WixVariable Id="WixUILicenseRtf" Value="$(var.NullDestination.ProjectDir)\License.rtf" />

    <Property Id="SSIS32_2016_PATH">
      <!-- Value="C:\Program Files (x86)\Microsoft SQL Server\130\DTS"> -->
      <RegistrySearch Type="directory" Id="SSIS32_2016_PATH_1" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\130\SSIS\Setup\DTSPath" Win64="no"/>
      <RegistrySearch Type="directory" Id="SSIS32_2016_PATH_2" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\130\DTS\Setup" Name="SQLPath" Win64="no"/>
      <DirectorySearch AssignToProperty="yes" Id="SSIS32_2016_PATH_3" Path="[ProgramFilesFolder]\Microsoft SQL Server\130\DTS" />
    </Property>
    <Property Id="SSIS32_2014_PATH">
      <!-- Value="C:\Program Files (x86)\Microsoft SQL Server\120\DTS"> -->
      <RegistrySearch Type="directory" Id="SSIS32_2014_PATH_1" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\120\SSIS\Setup\DTSPath" Win64="no"/>
      <RegistrySearch Type="directory" Id="SSIS32_2014_PATH_2" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\120\DTS\Setup" Name="SQLPath" Win64="no"/>
      <DirectorySearch AssignToProperty="yes" Id="SSIS32_2014_PATH_3" Path="[ProgramFilesFolder]\Microsoft SQL Server\120\DTS" />
    </Property>
    <Property Id="SSIS32_2012_PATH">
      <!-- Value="C:\Program Files (x86)\Microsoft SQL Server\110\DTS"> -->
      <RegistrySearch Type="directory" Id="SSIS32_2012_PATH_1" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\110\SSIS\Setup\DTSPath" Win64="no"/>
      <RegistrySearch Type="directory" Id="SSIS32_2012_PATH_2" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\110\DTS\Setup" Name="SQLPath" Win64="no"/>
      <DirectorySearch AssignToProperty="yes" Id="SSIS32_2012_PATH_3" Path="[ProgramFilesFolder]\Microsoft SQL Server\110\DTS" />
    </Property>

    <Property Id="SSIS32_2016">
      <RegistrySearch Type="raw" Id="SSIS32_2016_1" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\130\DTS\Setup" Name="Edition" Win64="no"/>
      <RegistrySearch Type="raw" Id="SSIS32_2016_2" Root="HKCR" Key="IntegrationServices.Package.130" Win64="no"/>
    </Property>

    <Property Id="SSIS32_2014">
      <RegistrySearch Type="raw" Id="SSIS32_2014_1" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\120\DTS\Setup" Name="Edition" Win64="no"/>
      <RegistrySearch Type="raw" Id="SSIS32_2014_2" Root="HKCR" Key="IntegrationServices.Package.120" Win64="no"/>
    </Property>

    <Property Id="SSIS32_2012">
      <RegistrySearch Type="raw" Id="SSIS32_2012_1" Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\110\DTS\Setup" Name="ProductID" Win64="no"/>
      <RegistrySearch Type="raw" Id="SSIS32_2012_2" Root="HKCR" Key="IntegrationServices.Package.110" Win64="no"/>
    </Property>

    <Condition Message="You need to be an administrator to install this product.">
      Privileged
    </Condition>

    <Directory Id="TARGETDIR" Name="SourceDir">
      
      <Directory Id="GAC2016" Name="GAC2016">
        <Component Id="SQL2016GAC" Guid="A17D6056-C38E-411C-9AFF-3C53283F78BD">
          <File Id="SQL2016DLLGAC" Name="$(var.NullDestination2016.TargetFileName)" Source="$(var.NullDestination2016.TargetPath)" Assembly=".net" KeyPath="yes" Checksum="yes"/>
        </Component>
      </Directory>

      <Directory Id="GAC2014" Name="GAC2014">
        <Component Id="SQL2014GAC" Guid="32BD89BB-7EEA-41ED-8832-C29AD17E2F71">
          <File Id="SQL2014DLLGAC" Name="$(var.NullDestination2014.TargetFileName)" Source="$(var.NullDestination2014.TargetPath)" Assembly=".net" KeyPath="yes" Checksum="yes"/>
        </Component>
      </Directory>

      <Directory Id="GAC2012" Name="GAC2012">
        <Component Id="SQL2012GAC" Guid="03F16F6D-7013-4EAB-995C-BC3059659DC3">
          <File Id="SQL2012DLLGAC" Name="$(var.NullDestination2012.TargetFileName)" Source="$(var.NullDestination2012.TargetPath)" Assembly=".net" KeyPath="yes" Checksum="yes"/>
        </Component>
      </Directory>

      <Directory Id="SSIS32_2016_PATH" Name="SSIS32_2016_PATH">
        <Directory Id="SQL2016x32Pipeline" Name="PipelineComponents">
          <Component Id="SQL2016x32DLL" Guid="53C11247-D90D-43E6-975E-F1972381279C" Win64="no">
            <File Id="SQL2016x32DLLFile" Name="$(var.NullDestination2016.TargetFileName)" Source="$(var.NullDestination2016.TargetPath)"  Checksum="yes"/>
          </Component>
        </Directory>
        <Directory Id="SQL2016x32Upgrade" Name="UpgradeMappings">
          <Component Id="SQL2016x32UpgradeMapping" Guid="B13196E0-1C72-4413-8C1E-20F0FB23C4FD" Win64="no">
            <File Id="SQL2016x32UpgradeFile" Name="NullDestination.xml" Source="$(var.NullDestination2016.ProjectDir)\NullDestination.xml" Checksum="yes"/>
          </Component>
          <Component Id="SQL2016x32UpgradeMappingExtension" Guid="250C57CF-92F7-47D3-9E60-81D79B7F3DA1" Win64="no">
            <File Id="SQL2016x32UpgradeFileExtension" Name="NullDestination.extensions.xml" Source="$(var.NullDestination2016.ProjectDir)\NullDestination.extensions.xml" Checksum="yes"/>
          </Component>
        </Directory>
      </Directory>

      <Directory Id="SSIS32_2014_PATH" Name="SSIS32_2014_PATH">
        <Directory Id="SQL2014x32Pipeline" Name="PipelineComponents">
          <Component Id="SQL2014x32DLL" Guid="9E115C03-BFED-4E25-96C5-38101001A30E" Win64="no">
            <File Id="SQL2014x32DLLFile" Name="$(var.NullDestination2014.TargetFileName)" Source="$(var.NullDestination2014.TargetPath)"  Checksum="yes"/>
          </Component>
        </Directory>
        <Directory Id="SQL2014x32Upgrade" Name="UpgradeMappings">
          <Component Id="SQL2014x32UpgradeMapping" Guid="F4AD083A-C079-4042-B465-B6EC3533E7D6" Win64="no">
            <File Id="SQL2014x32UpgradeFile" Name="NullDestination.xml" Source="$(var.NullDestination2014.ProjectDir)\NullDestination.xml" Checksum="yes"/>
          </Component>
          <Component Id="SQL2014x32UpgradeMappingExtension" Guid="E5E9503D-BF63-45E9-93F3-D81A3C7AB072" Win64="no">
            <File Id="SQL2014x32UpgradeFileExtension" Name="NullDestination.extensions.xml" Source="$(var.NullDestination2014.ProjectDir)\NullDestination.extensions.xml" Checksum="yes"/>
          </Component>
        </Directory>
      </Directory>

      <Directory Id="SSIS32_2012_PATH" Name="SSIS32_2012_PATH">
        <Directory Id="SQL2012x32Pipeline" Name="PipelineComponents">
          <Component Id="SQL2012x32DLL" Guid="11CAEB1C-E1A7-4D7C-BC33-C3E003D1D6F6" Win64="no">
            <File Id="SQL2012x32DLLFile" Name="$(var.NullDestination2012.TargetFileName)" Source="$(var.NullDestination2012.TargetPath)"  Checksum="yes"/>
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="Complete" Level="1" Title="Null Destination Installer" Description="An SSIS Component to provide a desitnation that just ignores all the records." Display="expand">
      <Feature Id="SQL2016" Level="1" Title="SQL 2016">
        <Feature Id="SQL2016x32" Level="1" Title="x86" ConfigurableDirectory="SSIS32_2016_PATH">
          <ComponentRef Id="SQL2016x32DLL"/>
          <ComponentRef Id="SQL2016x32UpgradeMapping"/>
          <ComponentRef Id="SQL2016x32UpgradeMappingExtension"/>
          <Condition Level="1004">NOT SSIS32_2016</Condition>
        </Feature>
        <ComponentRef Id="SQL2016GAC" />
        <Condition Level="1004">NOT (SSIS32_2016)</Condition>
      </Feature>
      <Feature Id="SQL2014" Level="1" Title="SQL 2014">
        <Feature Id="SQL2014x32" Level="1" Title="x86" ConfigurableDirectory="SSIS32_2014_PATH">
          <ComponentRef Id="SQL2014x32DLL"/>
          <ComponentRef Id="SQL2014x32UpgradeMapping"/>
          <ComponentRef Id="SQL2014x32UpgradeMappingExtension"/>
          <Condition Level="1004">NOT SSIS32_2014</Condition>
        </Feature>
        <ComponentRef Id="SQL2014GAC" />
        <Condition Level="1004">NOT (SSIS32_2014)</Condition>
      </Feature>
      <Feature Id="SQL2012" Level="1" Title="SQL 2012">
        <Feature Id="SQL2012x32" Level="1" Title="x86" ConfigurableDirectory="SSIS32_2012_PATH">
          <ComponentRef Id="SQL2012x32DLL"/>
          <Condition Level="1004">NOT SSIS32_2012</Condition>
        </Feature>
        <ComponentRef Id="SQL2012GAC" />
        <Condition Level="1004">NOT (SSIS32_2012)</Condition>
      </Feature>
    </Feature>

    <!-- Display a Warning dialog box IF SSIS isn't detected-->
    <UI>
      <InstallUISequence>
        <Show Dialog="SSISWarning" Before="ResumeDlg">NOT Installed AND NOT (SSIS64_2016 OR SSIS32_2016 OR SSIS64_2014 OR SSIS32_2014 OR SSIS64_2012 OR SSIS32_2012)</Show>
      </InstallUISequence>
      <Dialog Id="SSISWarning" Width="200" Height="100">
        <Control Type="Text" Id="text1" Width="194" Height="14" X="4" Y="8" Text="SQL Server Integration Services was not detected" />
        <Control Type="Text" Id="text2" Width="151" Height="12" X="4" Y="22" Text="Use Custom Install to install." />
        <Control Type="PushButton" Id="OK" Width="56" Height="17" X="68" Y="56" Text="OK">
          <Publish Event="EndDialog" Value="Return">1</Publish>
        </Control>
      </Dialog>
    </UI>

  </Product>
</Wix>